---
# Wazuh All-in-One Deployment Playbook
# This playbook installs Wazuh Indexer, Dashboard, and Manager on a single server
# Based on official Wazuh Ansible documentation:
# https://documentation.wazuh.com/current/deployment-options/deploying-with-ansible/

# Step 1: Generate certificates (runs locally, no sudo needed)
- hosts: wazuh_all_in_one
  become: no
  roles:
    - role: wazuh-ansible/roles/wazuh/wazuh-indexer
      perform_installation: false
  vars:
    indexer_node_master: true
    instances:
      node1:
        name: node-1       # Must match indexer_node_name
        ip: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        role: indexer
  tags:
    - generate-certs

# Step 2: Install all Wazuh components (single node)
- hosts: wazuh_all_in_one
  become: yes
  become_user: root
  roles:
    - role: wazuh-ansible/roles/wazuh/wazuh-indexer
    - role: wazuh-ansible/roles/wazuh/ansible-wazuh-manager
    - role: wazuh-ansible/roles/wazuh/ansible-filebeat-oss
    - role: wazuh-ansible/roles/wazuh/wazuh-dashboard
  vars:
    single_node: true
    minimum_master_nodes: 1
    indexer_node_master: true
    indexer_network_host: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
    filebeat_node_name: node-1
    filebeat_output_indexer_hosts:
      - "{{ hostvars[inventory_hostname]['ansible_host'] }}"
    instances:
      node1:
        name: node-1       # Must match indexer_node_name
        ip: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        role: indexer
    ansible_shell_allow_world_readable_temp: true
